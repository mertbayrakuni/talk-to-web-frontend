<style>
    .ttw-chatbot {
        box-sizing: border-box;
        width: 100%;
        max-width: 780px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif
    }

    .ttw-h {
        padding: 12px 16px;
        color: #fff;
        border-radius: 12px;
        background: linear-gradient(90deg, #4b6cb7, #182848)
    }

    .ttw-h h2 {
        margin: 0 0 2px;
        font-size: 18px
    }

    .ttw-h .s {
        opacity: .9;
        font-weight: 300;
        font-size: 13px
    }

    .ttw-log {
        background: #fff;
        border-radius: 12px;
        padding: 12px;
        height: 420px;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, .05)
    }

    .ttw-b {
        padding: 10px 14px;
        border-radius: 14px;
        max-width: 80%;
        position: relative;
        box-shadow: 0 2px 4px rgba(0, 0, 0, .05);
        animation: ttw-in .2s ease-out
    }

    .ttw-b.u {
        margin-left: auto;
        color: #fff;
        background: linear-gradient(135deg, #4facfe, #00f2fe);
        border-bottom-right-radius: 6px
    }

    .ttw-b.a {
        margin-right: auto;
        color: #222;
        background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
        border-bottom-left-radius: 6px
    }

    @keyframes ttw-in {
        from {
            opacity: 0;
            transform: translateY(6px)
        }
        to {
            opacity: 1;
            transform: none
        }
    }

    .ttw-ts {
        font-size: 11px;
        opacity: .75;
        margin-top: 6px;
        text-align: right
    }

    .ttw-row {
        display: flex;
        gap: 10px;
        align-items: center
    }

    .ttw-inp {
        flex: 1;
        padding: 12px 14px;
        border: 2px solid #e1e5eb;
        border-radius: 24px;
        font-size: 15px;
        outline: none
    }

    .ttw-inp:focus {
        border-color: #4b6cb7;
        box-shadow: 0 0 0 3px rgba(75, 108, 183, .18)
    }

    .ttw-send {
        padding: 10px 18px;
        border: 0;
        border-radius: 24px;
        font-weight: 600;
        cursor: pointer;
        color: #fff;
        background: linear-gradient(90deg, #4b6cb7, #182848);
        box-shadow: 0 4px 8px rgba(0, 0, 0, .1)
    }

    /* Modal */
    .tw-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 16, 30, .45);
        backdrop-filter: blur(2px);
        opacity: 0;
        transition: opacity .2s ease;
        z-index: 10000;
        pointer-events: none
    }

    .tw-overlay.open {
        opacity: 1;
        pointer-events: auto
    }

    .tw-panel {
        position: fixed;
        z-index: 10001;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 16px 48px rgba(0, 0, 0, .24);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        left: calc(50% - 380px);
        top: 10vh;
        width: 760px;
        height: 78vh;
        transform: translateY(10px);
        opacity: .98;
        transition: transform .25s ease, opacity .25s ease
    }

    .tw-panel.open {
        transform: none;
        opacity: 1
    }

    .tw-head {
        position: sticky;
        top: 0;
        z-index: 2;
        padding: 12px 56px 12px 16px;
        color: #fff;
        font-weight: 600;
        background: linear-gradient(90deg, #4b6cb7, #182848)
    }

    .tw-close {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 40px;
        height: 40px;
        border-radius: 999px;
        border: 0;
        background: rgba(0, 0, 0, .45);
        color: #fff;
        cursor: pointer;
        font-size: 22px;
        display: grid;
        place-items: center
    }

    .tw-body {
        flex: 1;
        overflow: auto;
        padding: 10px;
        background: #f7f9fc
    }

    .tw-body .ttw-chatbot {
        gap: 10px
    }

    .tw-body .ttw-log {
        height: auto;
        min-height: 40vh
    }

    @media (max-width: 860px) {
        .tw-panel {
            left: 2vw;
            top: 6vh;
            width: 96vw;
            height: 86vh
        }
    }

    /* Debug overlay */
    .ttw-debug {
        position: fixed;
        right: 10px;
        bottom: 10px;
        width: 420px;
        max-height: 46vh;
        background: #0b1020;
        color: #cde;
        z-index: 11000;
        border-radius: 8px;
        box-shadow: 0 8px 28px rgba(0, 0, 0, .5);
        display: none
    }

    .ttw-debug.open {
        display: block
    }

    .ttw-debug .hd {
        padding: 8px 10px;
        border-bottom: 1px solid #2a3558;
        font-weight: 600
    }

    .ttw-debug .bd {
        font-family: ui-monospace, Consolas, monospace;
        font-size: 12px;
        line-height: 1.35;
        padding: 8px 10px;
        max-height: 38vh;
        overflow: auto;
        white-space: pre-wrap
    }
</style>

<script>
    (function () {
        // ---------- tiny debug bus ----------
        const state = {overlay: null, body: null, enabled: true, history: []};

        function ts() {
            return new Date().toLocaleTimeString();
        }

        function ensureOverlay() {
            if (state.overlay) return;
            const box = document.createElement('div');
            box.className = 'ttw-debug';
            box.innerHTML = '<div class="hd">TTW Debug (F9 toggles)</div><div class="bd"></div>';
            document.body.appendChild(box);
            state.overlay = box;
            state.body = box.querySelector('.bd');
        }

        function log() {
            const args = [...arguments];
            console.log('[TTW]', ...args);
            ensureOverlay();
            const line = `[${ts()}] ` + args.map(x => {
                try {
                    return typeof x === 'string' ? x : JSON.stringify(x);
                } catch (e) {
                    return String(x);
                }
            }).join(' ');
            state.history.push(line);
            if (state.history.length > 400) state.history.shift();
            state.body.textContent = state.history.join('\n');
            state.body.scrollTop = state.body.scrollHeight;
        }

        window.addEventListener('keydown', (e) => {
            if (e.key === 'F9') {
                ensureOverlay();
                state.overlay.classList.toggle('open');
            }
        });
        window.TTW_DEBUG = {
            log, open: () => {
                ensureOverlay();
                state.overlay.classList.add('open');
            }
        };

        // ---------- UI helpers ----------
        function h(tag, attrs) {
            const el = document.createElement(tag);
            if (attrs) Object.keys(attrs).forEach(k => {
                const v = attrs[k];
                if (k === 'class') el.className = v; else if (k === 'text') el.textContent = v; else el.setAttribute(k, v);
            });
            for (let i = 2; i < arguments.length; i++) el.append(arguments[i]);
            return el;
        }

        function addBubble(chatEl, text, who) {
            const b = h('div', {class: 'ttw-b ' + (who === 'user' ? 'u' : 'a')}, text);
            b.append(h('div', {class: 'ttw-ts', text: ts()}));
            chatEl.append(b);
            chatEl.scrollTop = chatEl.scrollHeight;
        }

        // ---------- endpoint resolver ----------
        function resolveEndpoint(root, opts) {
            const scheme = location.protocol === 'https:' ? 'wss' : 'ws';
            if (opts && opts.endpoint) {
                log('endpoint via opts:', opts.endpoint);
                return opts.endpoint;
            }
            if (root && root.getAttribute('data-endpoint')) {
                const ep = root.getAttribute('data-endpoint');
                log('endpoint via data-endpoint:', ep);
                return ep;
            }
            if (window.TTW_WS) {
                log('endpoint via window.TTW_WS:', window.TTW_WS);
                return window.TTW_WS;
            }
            if (location.port === '9000') {
                const ep = `${scheme}://${location.hostname}:8000/ws`;
                log('endpoint via 9000→8000 rule:', ep);
                return ep;
            }
            const ep = `${scheme}://${location.host}/ws`;
            log('endpoint default same-origin:', ep);
            return ep;
        }

        // ---------- modal factory ----------
        function openModal(opts) {
            log('openModal called', opts || {});
            let overlay = document.querySelector('.tw-overlay');
            let panel = document.querySelector('.tw-panel');
            if (!overlay) {
                overlay = h('div', {class: 'tw-overlay'});
                document.body.appendChild(overlay);
            }
            if (!panel) {
                panel = h('div', {class: 'tw-panel'},
                    h('div', {class: 'tw-head'}, 'Olivia · Canlı Sohbet'),
                    h('button', {class: 'tw-close', type: 'button'}, '×'),
                    h('div', {class: 'tw-body'},
                        h('div', {class: 'ttw-chatbot', 'data-ttw-chatbot': '', 'data-autoinit': '1'},
                            h('header', {class: 'ttw-h'},
                                h('h2', {text: 'AI Chatbot'}),
                                h('div', {class: 's', text: 'Size yardımcı olmak için buradayım'})),
                            h('div', {class: 'ttw-log', role: 'log', 'aria-live': 'polite'}),
                            h('form', {class: 'ttw-row', autocomplete: 'off'},
                                h('input', {
                                    class: 'ttw-inp',
                                    type: 'text',
                                    placeholder: 'Mesajınızı yazın...',
                                    'aria-label': 'Mesajınızı yazın'
                                }),
                                h('button', {class: 'ttw-send', type: 'button'}, 'Gönder')))));
                document.body.appendChild(panel);
                panel.querySelector('.tw-close').onclick = () => {
                    overlay.classList.remove('open');
                    panel.classList.remove('open');
                };
                overlay.onclick = () => {
                    overlay.classList.remove('open');
                    panel.classList.remove('open');
                };
            }
            requestAnimationFrame(() => {
                overlay.classList.add('open');
                panel.classList.add('open');
            });
            const root = panel.querySelector('[data-ttw-chatbot]');
            mount(root, opts || {});
        }

        // ---------- core mount ----------
        function mount(root, opts) {
            opts = opts || {};
            if (!root) {
                log('mount: no root');
                return;
            }
            const chat = root.querySelector('.ttw-log');
            const input = root.querySelector('.ttw-inp');
            const sendB = root.querySelector('.ttw-send');
            const form = root.querySelector('form');

            form?.addEventListener('submit', (e) => {
                e.preventDefault();
                e.stopPropagation();
                log('form submit prevented');
            });
            sendB?.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                log('send clicked');
                send();
            });
            input?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    log('Enter pressed');
                    send();
                }
            });

            const endpoint = resolveEndpoint(root, opts);
            let ws = null, open = false, queue = [];

            function connect() {
                try {
                    log('WS connecting →', endpoint);
                    ws = new WebSocket(endpoint);
                    ws.addEventListener('open', onOpen);
                    ws.addEventListener('message', onMsg);
                    ws.addEventListener('error', onErr);
                    ws.addEventListener('close', onClose);
                } catch (err) {
                    log('WS ctor error', err);
                    setTimeout(connect, 900);
                }
            }

            function onOpen() {
                open = true;
                log('WS open');
                while (queue.length) {
                    try {
                        ws.send(queue.shift());
                    } catch (_) {
                        break;
                    }
                }
            }

            function onErr(e) {
                log('WS error', e);
            }

            function onClose() {
                open = false;
                log('WS close — retry in 1.2s');
                setTimeout(connect, 1200);
            }

            function sendRaw(s) {
                if (!s) return;
                if (ws && ws.readyState === 1 && open) {
                    try {
                        ws.send(s);
                        log('WS →', s);
                    } catch (e) {
                        log('WS send err', e);
                    }
                } else {
                    queue.push(s);
                    log('WS queued', s);
                }
            }

            function send() {
                const txt = (input?.value || '').trim();
                if (!txt) return;
                addBubble(chat, txt, 'user');
                sendRaw(txt);
                if (input) input.value = '';
            }

            function onMsg(ev) {
                log('WS ← raw', ev.data);
                try {
                    const data = JSON.parse(ev.data);
                    if (data.reply) {
                        addBubble(chat, data.reply, 'agent');
                    }
                    if (data.urls?.length) {
                        addBubble(chat, '👉 Görseller geldi (' + data.urls.length + ')', 'agent');
                    }
                } catch (err) {
                    addBubble(chat, ev.data, 'agent');
                    log('WS parse fail (non-JSON msg?)', err);
                }
            }

            connect();
            return {
                destroy() {
                    try {
                        ws?.close();
                    } catch (_) {
                    }
                    root.innerHTML = '';
                }
            };
        }

        window.TTWChatbot = {openModal, mount};

        document.addEventListener('DOMContentLoaded', () => {
            const inlines = document.querySelectorAll('[data-ttw-chatbot][data-autoinit]');
            if (inlines.length) {
                TTW_DEBUG.log('autoinit count', inlines.length);
                inlines.forEach(root => mount(root, {}));
            }
        });

        window.addEventListener('error', (e) => TTW_DEBUG.log('window error', e.message || e));
        window.addEventListener('unhandledrejection', (e) => TTW_DEBUG.log('promise rejection', e.reason || e));
    })();
</script>