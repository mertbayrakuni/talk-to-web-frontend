<!-- chatbot.html â€” popup grows from an origin element (mini card) -->
<style>
    /* core chat UI (unchanged) */
    .ttw-chatbot {
        box-sizing: border-box;
        width: 100%;
        max-width: 780px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
        font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif
    }

    .ttw-h {
        padding: 12px 16px;
        color: #fff;
        border-radius: 12px;
        background: linear-gradient(90deg, #4b6cb7, #182848)
    }

    .ttw-h h2 {
        margin: 0 0 2px;
        font-size: 18px
    }

    .ttw-h .s {
        opacity: .9;
        font-weight: 300;
        font-size: 13px
    }

    .ttw-log {
        background: #fff;
        border-radius: 12px;
        padding: 12px;
        height: 420px;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, .05)
    }

    .ttw-b {
        padding: 10px 14px;
        border-radius: 14px;
        max-width: 80%;
        position: relative;
        box-shadow: 0 2px 4px rgba(0, 0, 0, .05)
    }

    .ttw-b.u {
        margin-left: auto;
        color: #fff;
        background: linear-gradient(135deg, #4facfe, #00f2fe);
        border-bottom-right-radius: 6px
    }

    .ttw-b.a {
        margin-right: auto;
        color: #222;
        background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
        border-bottom-left-radius: 6px
    }

    .ttw-ts {
        font-size: 11px;
        opacity: .75;
        margin-top: 6px;
        text-align: right
    }

    .ttw-row {
        display: flex;
        gap: 10px;
        align-items: center
    }

    .ttw-inp {
        flex: 1;
        padding: 12px 14px;
        border: 2px solid #e1e5eb;
        border-radius: 24px;
        font-size: 15px;
        outline: none
    }

    .ttw-inp:focus {
        border-color: #4b6cb7;
        box-shadow: 0 0 0 3px rgba(75, 108, 183, .18)
    }

    .ttw-send {
        padding: 10px 18px;
        border: 0;
        border-radius: 24px;
        font-weight: 600;
        cursor: pointer;
        color: #fff;
        background: linear-gradient(90deg, #4b6cb7, #182848);
        box-shadow: 0 4px 8px rgba(0, 0, 0, .1)
    }

    /* modal chrome */
    body.tw-modal-open {
        overflow: hidden
    }

    .tw-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 16, 30, .45);
        backdrop-filter: blur(2px);
        z-index: 10000;
        opacity: 0;
        transition: opacity .38s ease;
    }

    .tw-overlay.open {
        opacity: 1
    }

    .tw-panel {
        position: fixed;
        z-index: 10001;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 16px 48px rgba(0, 0, 0, .24);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        left: calc(50% - 380px);
        top: 10vh;
        width: 760px;
        height: 78vh;
        transform-origin: top left;
        transition: transform .38s cubic-bezier(.2, .7, .2, 1), opacity .38s ease;
        will-change: transform, opacity;
        opacity: 0;
    }

    .tw-head {
        position: sticky;
        top: 0;
        z-index: 2;
        padding: 12px 56px 12px 16px;
        color: #fff;
        font-weight: 600;
        background: linear-gradient(90deg, #4b6cb7, #182848);
        padding-right: 72px
    }

    .tw-close {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 40px;
        height: 40px;
        border-radius: 999px;
        border: 0;
        background: rgba(0, 0, 0, .45);
        color: #fff;
        cursor: pointer;
        font-size: 22px;
        display: grid;
        place-items: center;
        z-index: 9
    }

    .tw-body {
        flex: 1;
        overflow: auto;
        padding: 10px;
        background: #f7f9fc;
        display: flex;
        flex-direction: column
    }

    .tw-body .ttw-chatbot {
        gap: 10px;
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0
    }

    .tw-body .ttw-log {
        height: auto;
        flex: 1;
        min-height: 0
    }

    /* MOBILE fullscreen */
    @media (max-width: 768px) {
        .tw-panel {
            left: 0;
            top: 0;
            width: 100vw;
            height: 100dvh;
            border-radius: 0;
            box-shadow: none
        }

        .tw-body {
            padding: 10px env(safe-area-inset-right) calc(10px + env(safe-area-inset-bottom)) env(safe-area-inset-left)
        }

        .tw-head {
            padding-left: 16px;
            padding-right: 72px
        }

        .tw-close {
            top: 6px;
            right: 6px;
            background: rgba(0, 0, 0, .30)
        }
    }
</style>

<script>
    (function () {
        /* ---------------- Debug (F9) ---------------- */
        const DBG = {box: null, body: null, lines: []};
        const dlog = (...a) => {
            try {
                if (!DBG.box) {
                    const el = document.createElement('div');
                    el.className = 'ttw-debug';
                    el.innerHTML = '<div class="hd">TTW Debug (F9)</div><div class="bd"></div>';
                    document.body.appendChild(el);
                    DBG.box = el;
                    DBG.body = el.querySelector('.bd');
                    window.addEventListener('keydown', e => {
                        if (e.key === 'F9') DBG.box.classList.toggle('open')
                    });
                }
                const line = '[' + new Date().toLocaleTimeString() + '] ' + a.map(x => {
                    try {
                        return typeof x === 'string' ? x : JSON.stringify(x)
                    } catch {
                        return String(x)
                    }
                }).join(' ');
                DBG.lines.push(line);
                if (DBG.lines.length > 400) DBG.lines.shift();
                DBG.body.textContent = DBG.lines.join('\n');
                DBG.body.scrollTop = DBG.body.scrollHeight;
                console.log('[TTW]', ...a);
            } catch {
            }
        };

        function getSid() {
            try {
                let sid = localStorage.getItem('ttw_sid');
                if (!sid) {
                    sid = (crypto?.randomUUID?.() || Math.random().toString(36).slice(2));
                    localStorage.setItem('ttw_sid', sid);
                }
                return sid;
            } catch {
                return Math.random().toString(36).slice(2);
            }
        }

        function addBubble(chatEl, text, who) {
            if (!chatEl) return;
            const w = document.createElement('div');
            w.className = 'ttw-b ' + (who === 'user' ? 'u' : 'a');
            w.textContent = text;
            const ts = document.createElement('div');
            ts.className = 'ttw-ts';
            ts.textContent = new Date().toLocaleTimeString();
            w.appendChild(ts);
            chatEl.appendChild(w);
            chatEl.scrollTop = chatEl.scrollHeight;
        }

        function resolveEndpoint(root, opts) {
            const scheme = location.protocol === 'https:' ? 'wss' : 'ws';
            if (opts?.endpoint) {
                dlog('endpoint via opts', opts.endpoint);
                return opts.endpoint;
            }
            if (root?.dataset.endpoint) {
                dlog('endpoint via data-endpoint', root.dataset.endpoint);
                return root.dataset.endpoint;
            }
            if (window.TTW_WS) {
                dlog('endpoint via window.TTW_WS', window.TTW_WS);
                return window.TTW_WS;
            }
            if (location.port === '9000') {
                const ep = `${scheme}://${location.hostname}:8000/ws`;
                dlog('endpoint 9000â†’8000', ep);
                return ep;
            }
            const ep = `${scheme}://${location.host}/ws`;
            dlog('endpoint default', ep);
            return ep;
        }

        /* ---- utility: rect in page coords ---- */
        function pageRect(el) {
            const r = el.getBoundingClientRect();
            return {left: r.left + window.scrollX, top: r.top + window.scrollY, width: r.width, height: r.height};
        }

        /* ---------------- Modal with grow-from-origin ---------------- */
        function openModal(opts) {
            const overlay = document.createElement('div');
            overlay.className = 'tw-overlay';
            const panel = document.createElement('div');
            panel.className = 'tw-panel';
            panel.innerHTML = `
      <div class="tw-head">Olivia Â· CanlÄ± Sohbet<button class="tw-close" type="button">Ã—</button></div>
      <div class="tw-body">
        <div class="ttw-chatbot" data-ttw-chatbot data-autoinit="1">
          <header class="ttw-h"><h2>AI Chatbot</h2><div class="s">Size yardÄ±mcÄ± olmak iÃ§in buradayÄ±m</div></header>
          <div class="ttw-log" role="log" aria-live="polite"></div>
          <form class="ttw-row" autocomplete="off">
            <input class="ttw-inp" type="text" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." aria-label="MesajÄ±nÄ±zÄ± yazÄ±n">
            <button class="ttw-send" type="button">GÃ¶nder</button>
          </form>
        </div>
      </div>`;

            document.body.append(overlay, panel);
            document.body.classList.add('tw-modal-open');

            /* FLIP: set initial transform so panel overlaps origin, then transition to identity */
            const originEl = typeof opts?.animateFrom === 'string' ? document.querySelector(opts.animateFrom) : (opts?.animateFrom || null);
            const doGrow = originEl && originEl.getBoundingClientRect().width > 0 && originEl.getBoundingClientRect().height > 0;

            // compute transforms with origin top-left
            function setFromOrigin() {
                const t = panel.getBoundingClientRect();
                const p = pageRect(panel); // current page pos
                const o = pageRect(originEl);
                const sx = Math.max(0.01, o.width / t.width);
                const sy = Math.max(0.01, o.height / t.height);
                const dx = (o.left - p.left);
                const dy = (o.top - p.top);
                panel.style.transformOrigin = 'top left';
                panel.style.transform = `translate(${dx}px, ${dy}px) scale(${sx}, ${sy})`;
                panel.style.opacity = '0.001';
            }

            // start animation
            requestAnimationFrame(() => {
                if (doGrow) setFromOrigin();
                requestAnimationFrame(() => {
                    overlay.classList.add('open');
                    panel.style.transform = 'none';
                    panel.style.opacity = '1';
                });
            });

            const controller = mount(panel.querySelector('[data-ttw-chatbot]'), opts || {});

            function close() {
                // reverse animation if origin is still visible
                if (doGrow) {
                    setFromOrigin();
                    overlay.classList.remove('open');
                    const done = () => {
                        panel.removeEventListener('transitionend', done);
                        cleanup();
                    };
                    panel.addEventListener('transitionend', done);
                } else {
                    cleanup();
                }
            }

            function cleanup() {
                try {
                    controller?.destroy?.();
                } catch {
                }
                try {
                    overlay.remove();
                } catch {
                }
                try {
                    panel.remove();
                } catch {
                }
                document.body.classList.remove('tw-modal-open');
            }

            panel.querySelector('.tw-close').onclick = e => {
                e.preventDefault();
                close();
            };
            overlay.onclick = e => {
                if (e.target === overlay) close();
            };
        }

        /* ---------------- Core mount ---------------- */
        function mount(root, opts) {
            if (!root) return {
                destroy() {
                }
            };
            const chat = root.querySelector('.ttw-log');
            const input = root.querySelector('.ttw-inp');
            const sendB = root.querySelector('.ttw-send');
            const form = root.querySelector('form');

            form?.addEventListener('submit', e => {
                e.preventDefault();
                e.stopPropagation();
            });
            sendB?.addEventListener('click', e => {
                e.preventDefault();
                e.stopPropagation();
                send();
            });
            input?.addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    send();
                }
            });

            const base = resolveEndpoint(root, opts);
            const url = base + (base.includes('?') ? '&' : '?') + 'client_id=' + encodeURIComponent(getSid());
            let ws = null, open = false, queue = [];

            function connect() {
                try {
                    dlog('WS connecting â†’', url);
                    ws = new WebSocket(url);
                    ws.addEventListener('open', () => {
                        open = true;
                        dlog('WS open');
                        while (queue.length) {
                            try {
                                ws.send(queue.shift());
                            } catch {
                                break;
                            }
                        }
                    });
                    ws.addEventListener('message', onMsg);
                    ws.addEventListener('error', e => dlog('WS error', e));
                    ws.addEventListener('close', () => {
                        open = false;
                        dlog('WS close â€” retry in 1.2s');
                        setTimeout(connect, 1200);
                    });
                } catch (err) {
                    dlog('WS ctor error', err);
                    setTimeout(connect, 900);
                }
            }

            function sendRaw(s) {
                if (!s) return;
                if (ws && open && ws.readyState === 1) {
                    try {
                        ws.send(s);
                        dlog('WS â†’', s);
                    } catch (e) {
                        dlog('WS send err', e);
                    }
                } else {
                    queue.push(s);
                    dlog('WS queued', s);
                }
            }

            function send() {
                const txt = (input?.value || '').trim();
                if (!txt) return;
                addBubble(chat, txt, 'user');
                sendRaw(txt);
                if (input) input.value = '';
            }

            function onMsg(ev) {
                dlog('WS â†', ev.data);
                try {
                    const data = JSON.parse(ev.data);
                    if (data.reply) addBubble(chat, data.reply, 'agent');
                    if (data.urls?.length) addBubble(chat, 'ðŸ‘‰ GÃ¶rseller geldi (' + data.urls.length + ')', 'agent');
                } catch {
                    addBubble(chat, ev.data, 'agent');
                }
            }

            connect();
            const first = (opts.initialText || '').trim();
            if (first) {
                addBubble(chat, first, 'user');
                sendRaw(first);
            }
            return {
                destroy() {
                    try {
                        ws?.close();
                    } catch {
                    }
                }
            };
        }

        // expose
        window.TTWChatbot = {openModal, mount};

        // optional auto-init
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('[data-ttw-chatbot][data-autoinit]').forEach(root => mount(root, {}));
        });

        window.addEventListener('error', e => dlog('window error', e.message || e));
        window.addEventListener('unhandledrejection', e => dlog('promise rejection', e.reason || e));
    })();
</script>
