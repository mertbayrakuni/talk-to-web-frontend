<!-- chatbot.html — popup grows from an origin element (mini card) -->
<style>
    /* core chat UI */
    .ttw-chatbot {
        box-sizing: border-box;
        width: 100%;
        max-width: 780px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
        font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif
    }

    .ttw-h {
        padding: 12px 16px;
        color: #fff;
        border-radius: 12px;
        background: linear-gradient(90deg, #4b6cb7, #182848)
    }

    .ttw-h h2 {
        margin: 0 0 2px;
        font-size: 18px
    }

    .ttw-h .s {
        opacity: .9;
        font-weight: 300;
        font-size: 13px
    }

    .ttw-log {
        background: #fff;
        border-radius: 12px;
        padding: 12px;
        height: 420px;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, .05)
    }

    .ttw-b {
        padding: 10px 14px;
        border-radius: 14px;
        max-width: 80%;
        position: relative;
        box-shadow: 0 2px 4px rgba(0, 0, 0, .05)
    }

    .ttw-b.u {
        margin-left: auto;
        color: #fff;
        background: linear-gradient(135deg, #4facfe, #00f2fe);
        border-bottom-right-radius: 6px
    }

    .ttw-b.a {
        margin-right: auto;
        color: #222;
        background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
        border-bottom-left-radius: 6px
    }

    .ttw-ts {
        font-size: 11px;
        opacity: .75;
        margin-top: 6px;
        text-align: right
    }

    .ttw-row {
        display: flex;
        gap: 10px;
        align-items: center
    }

    .ttw-inp {
        flex: 1;
        padding: 12px 14px;
        border: 2px solid #e1e5eb;
        border-radius: 24px;
        font-size: 15px;
        outline: none
    }

    .ttw-inp:focus {
        border-color: #4b6cb7;
        box-shadow: 0 0 0 3px rgba(75, 108, 183, .18)
    }

    .ttw-send {
        padding: 10px 18px;
        border: 0;
        border-radius: 24px;
        font-weight: 600;
        cursor: pointer;
        color: #fff;
        background: linear-gradient(90deg, #4b6cb7, #182848);
        box-shadow: 0 4px 8px rgba(0, 0, 0, .1)
    }

    /* image gallery */
    .ttw-b.has-gallery {
        max-width: 100%;
    }

    .ttw-gallery {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr)); /* phones */
        gap: 10px;
    }

    @media (min-width: 480px) {
        .ttw-gallery {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }
    }

    @media (min-width: 768px) {
        .ttw-gallery {
            grid-template-columns: repeat(4, minmax(0, 1fr));
        }
    }

    .ttw-gallery a {
        display: block;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 0 0 0 rgba(0, 0, 0, .08);
        transition: box-shadow .15s;
    }

    .ttw-gallery img {
        width: 100%;
        height: 100px;
        object-fit: cover;
        display: block;
        transition: transform .18s ease
    }

    .ttw-gallery a:hover img {
        transform: scale(1.035);
        box-shadow: 0 4px 12px rgba(0, 0, 0, .12);
    }

    /* modal chrome */
    body.tw-modal-open {
        overflow: hidden
    }

    .tw-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 16, 30, .45);
        backdrop-filter: blur(2px);
        z-index: 10000;
        opacity: 0;
        transition: opacity .38s ease
    }

    .tw-overlay.open {
        opacity: 1
    }

    .tw-panel {
        position: fixed;
        z-index: 10001;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 16px 48px rgba(0, 0, 0, .24);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        left: calc(50% - 380px);
        top: 10vh;
        width: 760px;
        height: 78vh;
        transform-origin: top left;
        transition: transform .38s cubic-bezier(.2, .7, .2, 1), opacity .38s ease;
        will-change: transform, opacity;
        opacity: 0
    }

    .tw-head {
        position: sticky;
        top: 0;
        z-index: 2;
        padding: 12px 56px 12px 16px;
        color: #fff;
        font-weight: 600;
        background: linear-gradient(90deg, #4b6cb7, #182848);
        padding-right: 72px
    }

    .tw-close {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 40px;
        height: 40px;
        border-radius: 999px;
        border: 0;
        background: rgba(0, 0, 0, .45);
        color: #fff;
        cursor: pointer;
        font-size: 22px;
        display: grid;
        place-items: center;
        z-index: 9
    }

    .tw-body {
        flex: 1;
        overflow: auto;
        padding: 10px;
        background: #f7f9fc;
        display: flex;
        flex-direction: column
    }

    .tw-body .ttw-chatbot {
        gap: 10px;
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0
    }

    .tw-body .ttw-log {
        height: auto;
        flex: 1;
        min-height: 0
    }

    @media (max-width: 768px) {
        .tw-panel {
            left: 0;
            top: 0;
            width: 100vw;
            height: 100dvh;
            border-radius: 0;
            box-shadow: none
        }

        .tw-body {
            padding: 10px env(safe-area-inset-right) calc(10px + env(safe-area-inset-bottom)) env(safe-area-inset-left)
        }

        .tw-head {
            padding-left: 16px;
            padding-right: 72px
        }

        .tw-close {
            top: 6px;
            right: 6px;
            background: rgba(0, 0, 0, .3)
        }
    }

    /* typing indicator (three bouncing dots) */
    .ttw-b.ttw-typing {
        margin-right: auto; /* assistant side */
        color: #3b4a6b;
        background: #eef3ff;
    }

    .ttw-typing .dots {
        display: inline-flex;
        gap: 4px;
        vertical-align: middle;
    }

    .ttw-typing .dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #3b4a6b;
        opacity: .32;
        animation: ttw-bounce 1s infinite ease-in-out;
    }

    .ttw-typing .dot:nth-child(2) {
        animation-delay: .15s;
    }

    .ttw-typing .dot:nth-child(3) {
        animation-delay: .30s;
    }

    @keyframes ttw-bounce {
        0%, 80%, 100% {
            transform: translateY(0);
            opacity: .32;
        }
        40% {
            transform: translateY(-4px);
            opacity: .95;
        }
    }

</style>

<script>
    (() => {
        /* ---------------- Debug (F9) ---------------- */
        const DBG = {box: null, body: null, lines: []};
        const dlog = (...a) => {
            try {
                if (!DBG.box) {
                    const el = document.createElement('div');
                    el.className = 'ttw-debug';
                    el.innerHTML = '<div class="hd">TTW Debug (F9)</div><div class="bd"></div>';
                    document.body.appendChild(el);
                    DBG.box = el;
                    DBG.body = el.querySelector('.bd');
                    window.addEventListener('keydown', e => {
                        if (e.key === 'F9') DBG.box.classList.toggle('open');
                    });
                }
                const line = '[' + new Date().toLocaleTimeString() + '] ' + a.map(x => {
                    try {
                        return typeof x === 'string' ? x : JSON.stringify(x);
                    } catch {
                        return String(x);
                    }
                }).join(' ');
                DBG.lines.push(line);
                if (DBG.lines.length > 400) DBG.lines.shift();
                DBG.body.textContent = DBG.lines.join('\n');
                DBG.body.scrollTop = DBG.body.scrollHeight;
                console.log('[TTW]', ...a);
            } catch {
            }
        };

        function getSid() {
            try {
                let sid = localStorage.getItem('ttw_sid');
                if (!sid) {
                    sid = (crypto?.randomUUID?.() || Math.random().toString(36).slice(2));
                    localStorage.setItem('ttw_sid', sid);
                }
                return sid;
            } catch {
                return Math.random().toString(36).slice(2);
            }
        }

        /* Basic bubble (used for user messages and fallback) */
        function addBubble(chatEl, text, who) {
            if (!chatEl) return;
            const w = document.createElement('div');
            w.className = 'ttw-b ' + (who === 'user' ? 'u' : 'a');
            w.textContent = text;
            const ts = document.createElement('div');
            ts.className = 'ttw-ts';
            ts.textContent = new Date().toLocaleTimeString();
            w.appendChild(ts);
            chatEl.appendChild(w);
            chatEl.scrollTop = chatEl.scrollHeight;
        }

        /* ---- typing indicator bubble ---- */
        function showTyping(chatEl) {
            const b = document.createElement('div');
            b.className = 'ttw-b a ttw-typing';
            b.innerHTML = '<span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>';
            chatEl.appendChild(b);
            chatEl.scrollTop = chatEl.scrollHeight;
            return () => {
                try {
                    b.remove();
                } catch {
                }
            };
        }

        /* ---- split a reply into "steps" (blank lines & list markers) ---- */
        function splitSteps(text) {
            const clean = (text || '').replace(/\r/g, '').trim();
            if (!clean) return [];
            const out = [];
            const lines = clean.split('\n');
            let buf = [];
            const isList = s => /^\s*(?:\d+[.)]|[-••])\s+/.test(s);

            for (const ln of lines) {
                if (!ln.trim()) {
                    if (buf.length) {
                        out.push(buf.join(' ').trim());
                        buf = [];
                    }
                    continue;
                }
                if (isList(ln) && buf.length) {
                    out.push(buf.join(' ').trim());
                    buf = [ln.replace(/^\s*(?:\d+[.)]|[-••])\s+/, '')];
                } else {
                    buf.push(ln.replace(/^\s*(?:\d+[.)]|[-••])\s*/, ''));
                }
            }
            if (buf.length) out.push(buf.join(' ').trim());
            return out.length ? out : [clean];
        }

        /* ---- typewriter effect for a single bubble ---- */
        function typeWriter(targetEl, text, speed = 18) {
            return new Promise(resolve => {
                let i = 0;
                const id = setInterval(() => {
                    targetEl.textContent += text.charAt(i++);
                    if (i >= text.length) {
                        clearInterval(id);
                        resolve();
                    }
                }, speed);
            });
        }

        /* ---- render Olivia's reply in steps with typing indicator ---- */
        async function renderAssistantReply(chatEl, fullText) {
            const steps = splitSteps(fullText).slice(0, 8); // safety cap
            for (let i = 0; i < steps.length; i++) {
                const remove = showTyping(chatEl);            // show typing...
                const w = document.createElement('div');      // ...prepare bubble
                w.className = 'ttw-b a';
                chatEl.appendChild(w);
                chatEl.scrollTop = chatEl.scrollHeight;
                remove();
                await typeWriter(w, steps[i]);                // daktilo typing
                const ts = document.createElement('div');
                ts.className = 'ttw-ts';
                ts.textContent = new Date().toLocaleTimeString();
                w.appendChild(ts);
            }
        }

        /* path -> absolute URL */
        function resolveUrl(u) {
            if (!u) return null;
            if (/^https?:\/\//i.test(u)) return u;
            if (u.startsWith('//')) return location.protocol + u;
            if (u.startsWith('/')) return location.origin + u;
            return location.origin + '/' + u.replace(/^\.?\//, '');
        }

        /* render a responsive gallery; accepts strings or {adres,image} */
        function addImageGallery(chatEl, items) {
            if (!chatEl || !items?.length) return;
            const wrap = document.createElement('div');
            wrap.className = 'ttw-b a has-gallery';
            const grid = document.createElement('div');
            grid.className = 'ttw-gallery';

            items.slice(0, 12).forEach(it => {
                const imgSrc = resolveUrl(typeof it === 'string' ? it : (it?.image || it?.adres));
                const href = resolveUrl(typeof it === 'string' ? it : (it?.adres || it?.image));
                if (!imgSrc) return;

                const a = document.createElement('a');
                a.href = href || imgSrc;
                a.target = '_blank';
                a.rel = 'noopener noreferrer';

                const img = document.createElement('img');
                img.src = imgSrc;
                img.alt = 'görsel';
                img.loading = 'lazy';

                a.appendChild(img);
                grid.appendChild(a);
            });

            wrap.appendChild(grid);
            const ts = document.createElement('div');
            ts.className = 'ttw-ts';
            ts.textContent = new Date().toLocaleTimeString();
            wrap.appendChild(ts);

            chatEl.appendChild(wrap);
            chatEl.scrollTop = chatEl.scrollHeight;
        }

        function resolveEndpoint(root, opts) {
            const scheme = location.protocol === 'https:' ? 'wss' : 'ws';
            if (opts?.endpoint) {
                dlog('endpoint via opts', opts.endpoint);
                return opts.endpoint;
            }
            if (root?.dataset.endpoint) {
                dlog('endpoint via data-endpoint', root.dataset.endpoint);
                return root.dataset.endpoint;
            }
            if (window.TTW_WS) {
                dlog('endpoint via window.TTW_WS', window.TTW_WS);
                return window.TTW_WS;
            }
            if (location.port === '9000') {
                const ep = `${scheme}://${location.hostname}:8000/ws`;
                dlog('endpoint 9000→8000', ep);
                return ep;
            }
            const ep = `${scheme}://${location.host}/ws`;
            dlog('endpoint default', ep);
            return ep;
        }

        function pageRect(el) {
            const r = el.getBoundingClientRect();
            return {left: r.left + scrollX, top: r.top + scrollY, width: r.width, height: r.height};
        }

        /* ---------------- Modal with grow-from-origin ---------------- */
        function openModal(opts) {
            const overlay = document.createElement('div');
            overlay.className = 'tw-overlay';
            const panel = document.createElement('div');
            panel.className = 'tw-panel';
            panel.innerHTML = `
      <div class="tw-head">Olivia · Canlı Sohbet<button class="tw-close" type="button">×</button></div>
      <div class="tw-body">
        <div class="ttw-chatbot" data-ttw-chatbot data-autoinit="1">
          <header class="ttw-h"><h2>AI Chatbot</h2><div class="s">Size yardımcı olmak için buradayım</div></header>
          <div class="ttw-log" role="log" aria-live="polite"></div>
          <form class="ttw-row" autocomplete="off">
            <input class="ttw-inp" type="text" placeholder="Mesajınızı yazın..." aria-label="Mesajınızı yazın">
            <button class="ttw-send" type="button">Gönder</button>
          </form>
        </div>
      </div>`;
            document.body.append(overlay, panel);
            document.body.classList.add('tw-modal-open');

            const originEl = typeof opts?.animateFrom === 'string' ? document.querySelector(opts.animateFrom) : (opts?.animateFrom || null);
            const doGrow = originEl && originEl.getBoundingClientRect().width > 0 && originEl.getBoundingClientRect().height > 0;

            function setFromOrigin() {
                const t = panel.getBoundingClientRect(), p = pageRect(panel), o = pageRect(originEl);
                const sx = Math.max(0.01, o.width / t.width), sy = Math.max(0.01, o.height / t.height);
                const dx = (o.left - p.left), dy = (o.top - p.top);
                panel.style.transformOrigin = 'top left';
                panel.style.transform = `translate(${dx}px,${dy}px) scale(${sx},${sy})`;
                panel.style.opacity = '0.001';
            }

            requestAnimationFrame(() => {
                if (doGrow) setFromOrigin();
                requestAnimationFrame(() => {
                    overlay.classList.add('open');
                    panel.style.transform = 'none';
                    panel.style.opacity = '1';
                });
            });

            const controller = mount(panel.querySelector('[data-ttw-chatbot]'), opts || {});

            function close() {
                if (doGrow) {
                    setFromOrigin();
                    overlay.classList.remove('open');
                    const done = () => {
                        panel.removeEventListener('transitionend', done);
                        cleanup();
                    };
                    panel.addEventListener('transitionend', done);
                } else cleanup();
            }

            function cleanup() {
                try {
                    controller?.destroy?.();
                } catch {
                }
                try {
                    overlay.remove();
                } catch {
                }
                try {
                    panel.remove();
                } catch {
                }
                document.body.classList.remove('tw-modal-open');
            }

            panel.querySelector('.tw-close').onclick = e => {
                e.preventDefault();
                close();
            };
            overlay.onclick = e => {
                if (e.target === overlay) close();
            };
        }

        /* ---------------- Core mount ---------------- */
        function mount(root, opts) {
            if (!root) return {
                destroy() {
                }
            };
            const chat = root.querySelector('.ttw-log');
            const input = root.querySelector('.ttw-inp');
            const sendB = root.querySelector('.ttw-send');
            const form = root.querySelector('form');

            form?.addEventListener('submit', e => {
                e.preventDefault();
                e.stopPropagation();
            });
            sendB?.addEventListener('click', e => {
                e.preventDefault();
                e.stopPropagation();
                send();
            });
            input?.addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    send();
                }
            });

            const base = resolveEndpoint(root, opts);
            const url = base + (base.includes('?') ? '&' : '?') + 'client_id=' + encodeURIComponent(getSid());
            let ws = null, open = false, queue = [];
            let typingHintRemove = null;

            function connect() {
                try {
                    dlog('WS connecting →', url);
                    ws = new WebSocket(url);
                    ws.addEventListener('open', () => {
                        open = true;
                        dlog('WS open');
                        while (queue.length) {
                            try {
                                ws.send(queue.shift());
                            } catch {
                                break;
                            }
                        }
                    });
                    ws.addEventListener('message', onMsg);
                    ws.addEventListener('error', e => dlog('WS error', e));
                    ws.addEventListener('close', () => {
                        open = false;
                        dlog('WS close — retry in 1.2s');
                        setTimeout(connect, 1200);
                    });
                } catch (err) {
                    dlog('WS ctor error', err);
                    setTimeout(connect, 900);
                }
            }

            function sendRaw(s) {
                if (!s) return;
                if (ws && open && ws.readyState === 1) {
                    try {
                        ws.send(s);
                        dlog('WS →', s);
                    } catch (e) {
                        dlog('WS send err', e);
                    }
                } else {
                    queue.push(s);
                    dlog('WS queued', s);
                }
            }

            function send() {
                const txt = (input?.value || '').trim();
                if (!txt) return;
                addBubble(chat, txt, 'user');
                typingHintRemove?.();  // clear previous
                typingHintRemove = showTyping(chat);
                sendRaw(txt);
                if (input) input.value = '';
            }

            async function onMsg(ev) {
                dlog('WS ←', ev.data);
                try {
                    typingHintRemove?.();
                    typingHintRemove = null;
                } catch {
                }

                try {
                    const data = JSON.parse(ev.data);

                    if (data.reply) {
                        await renderAssistantReply(chat, data.reply);
                    }

                    // normalize & show images
                    let urls = data.urls;
                    if (typeof urls === 'string') {
                        try {
                            urls = JSON.parse(urls);
                        } catch {
                        }
                    }
                    if (!Array.isArray(urls) && typeof data.reply === 'string') {
                        const m = data.reply.match(/"urls"\s*:\s*(\[[\s\S]*?\])/);
                        if (m) {
                            try {
                                urls = JSON.parse(m[1]);
                            } catch {
                            }
                        }
                    }
                    if (Array.isArray(urls) && urls.length) {
                        addImageGallery(chat, urls.map(u => (typeof u === 'string') ? u : ({
                            adres: u?.adres || u?.image || '',
                            image: u?.image || u?.adres || ''
                        })));
                    }
                } catch {
                    await renderAssistantReply(chat, ev.data); // plain text fallback
                }
            }

            connect();
            const first = (opts.initialText || '').trim();
            if (first) {
                addBubble(chat, first, 'user');
                typingHintRemove?.();
                typingHintRemove = showTyping(chat);
                sendRaw(first);
            }

            return {
                destroy() {
                    try {
                        ws?.close();
                    } catch {
                    }
                }
            };
        }

        // expose
        window.TTWChatbot = {openModal, mount};

        // optional auto-init
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('[data-ttw-chatbot][data-autoinit]').forEach(root => mount(root, {}));
        });

        window.addEventListener('error', e => dlog('window error', e.message || e));
        window.addEventListener('unhandledrejection', e => dlog('promise rejection', e.reason || e));
    })();
</script>
